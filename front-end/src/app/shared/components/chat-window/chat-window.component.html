<div class="glass-panel flex h-[70vh] flex-col overflow-hidden" *ngIf="conversation; else emptyState">
  <header class="flex items-center gap-4 border-b border-white/5 px-6 py-4">
    <div class="grid h-12 w-12 place-items-center rounded-2xl bg-accent/20 text-lg font-semibold text-accent">
      {{ conversation?.friendUsername.charAt(0).toUpperCase() }}
    </div>
    <div>
      <h2 class="text-lg font-semibold text-white">{{ conversation?.friendUsername }}</h2>
      <p class="text-xs text-slate-400">Chat privata</p>
    </div>
  </header>

  <div #scroller class="flex-1 space-y-4 overflow-y-auto px-6 py-6">
    <div
      *ngFor="let message of messages"
      class="flex"
      [class.justify-end]="message.isMine"
    >
      <div
        class="max-w-xl rounded-3xl px-4 py-3 text-sm shadow-lg shadow-slate-900/30 transition"
        [ngClass]="
          message.isMine
            ? 'bg-gradient-to-r from-accent to-accent-soft text-slate-950'
            : 'bg-white/5 text-slate-100'
        "
      >
        <div class="text-xs font-semibold uppercase tracking-wide text-slate-300" [ngClass]="{ 'text-slate-900/80': message.isMine }">
          {{ message.senderUsername }}
        </div>
        <p class="mt-1 whitespace-pre-wrap text-sm leading-relaxed">{{ message.content }}</p>
        <span class="mt-2 block text-right text-[10px] uppercase tracking-wide text-slate-400" [ngClass]="{ 'text-slate-900/70': message.isMine }">
          {{ message.sentAt | date: 'short' }}
        </span>
      </div>
    </div>

    <div *ngIf="!messages?.length" class="rounded-3xl bg-white/5 px-4 py-6 text-center text-sm text-slate-400">
      Ancora nessun messaggio. Inizia la conversazione!
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="send()" class="grid gap-3 border-t border-white/5 px-6 py-4 sm:grid-cols-[1fr,auto]">
    <textarea
      formControlName="message"
      rows="2"
      class="min-h-[56px] w-full resize-none rounded-2xl border border-white/10 bg-slate-900/60 px-4 py-3 text-sm text-white outline-none transition focus:border-accent"
      placeholder="Scrivi un messaggio..."
      (keydown.enter)="onEnter($event)"
    ></textarea>
    <button type="submit" class="btn-primary sm:self-end" [disabled]="form.invalid">Invia</button>
  </form>
</div>

<ng-template #emptyState>
  <div class="glass-panel flex h-[60vh] flex-col items-center justify-center gap-3 px-6 py-8 text-center text-slate-300">
    <h3 class="text-lg font-semibold text-white">Seleziona una chat</h3>
    <p class="max-w-sm text-sm text-slate-400">Scegli una conversazione dalla lista per visualizzare i messaggi e continuare la discussione.</p>
  </div>
</ng-template>
